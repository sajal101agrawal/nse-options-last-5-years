# ğŸ“ˆ NSEâ€¯Optionsâ€¯Dataâ€¯Analysisâ€¯ToolkitÂ (2020â€¯â€“â€¯2025)

A oneâ€‘stop, **productionâ€‘ready pipeline** for *downloading*, *enriching*, *storing*, and *analysing* fiveÂ years of NSE derivatives data.
It fuses Bhavcopy files, Yahoo spot prices, interestâ€‘rate curves, and earnings calendars, then computes IV, RV, Greeks, IVâ€‘percentile / rank, and streams everything straight into **PostgreSQL** (JSONB) or a flat JSON file for ML workflows.

> ğŸ“… **Coverage**â€‚Latest fiveâ€¯years from the day you run the scripts
> ğŸ› ï¸ **Primary useâ€‘cases**â€‚Quantâ€¯research Â· Options & volatility dashboards Â· AI model training
> âš ï¸ **Disclaimer**â€‚Educational/research use only. Respect NSE & dataâ€‘provider T\&Cs.

---

## ğŸ“ Project layout

```
.
â”œâ”€â”€ bhavcopy/
â”‚   â”œâ”€â”€ raw/                    # Downloaded NSE ZIPs
â”‚   â””â”€â”€ extracted/              # Daily CSVs
â”œâ”€â”€ earning_dates/              # Earnings-calendar JSON
â”œâ”€â”€ interest_rates/             # FBIL MIFOR CSV
â”œâ”€â”€ yahoo_finance/              # Underlying spot-price JSON
â”œâ”€â”€ processed_data/             # Final merged dataset
â”œâ”€â”€ store_in_db/                # âœ bulk ETL into Postgres
â”‚   â”œâ”€â”€ store_s.py              # multiâ€‘threaded ETL driver
â”‚   â””â”€â”€ db_util.py              # connectionâ€‘pool & batchâ€‘upsert
â”œâ”€â”€ interactive_view/           # Optional HTML/JS plots
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ download_bhavcopy.py
â”‚   â”œâ”€â”€ download_yahoo_data.py
â”‚   â”œâ”€â”€ nse_fno_scripts.py
â”‚   â””â”€â”€ utilities.py
â”œâ”€â”€ process_data.py             # standâ€‘alone JSON pipeline
â”œâ”€â”€ nse_fno_scripts.json
â”œâ”€â”€ top_nse_fno_scripts.json
â”œâ”€â”€ nse_options_formulae.pdf    # maths reference
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md   â† you are here
```

*(macOS users: ignore any autoâ€‘created `__MACOSX/` folders.)*

---

## âœ¨ Feature highlights

| Category                | What you get                                                                                                                                                                                                       |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Data ingestion**      | â€¢ NSE Bhavcopy (zip â†’ CSV) â€¢ Yahooâ€¯Finance spot prices â€¢ FBIL MIFOR daily rates â€¢ Earnings calendar (Sensibullâ€‘style JSON)                                                                                         |
| **Analytics engine**    | â€¢ **Implied volatility** (30â€¯/â€¯60â€¯/â€¯90â€¯d) via Blackâ€‘Scholesâ€¯+â€¯bisection â€¢ **Realised vol** with Yangâ€‘Zhang â€¢ Full **Greeks** (Î”â€¯Î“â€¯Î˜â€¯Î½â€¯Ï) â€¢ Rolling 30â€‘day **IV percentile & rank**                                 |
| **Indexâ€‘aware logic**   | Correct handling of index *weekly* expiries â†’ bins into proper monthly buckets (30/60/90â€¯d).                                                                                                                       |
| **Storage options**     | 1ï¸âƒ£Â Write enriched JSON to `processed_data/processed_data.json` â€‚2ï¸âƒ£Â (*Recommended*) `store_in_db/store_s.py` bulkâ€‘upserts rows into **PostgreSQL** with JSONB columns, automatic retries, and connection pooling. |
| **Speed**               | Multithreaded symbol processing; NumPy releases the GIL â†’ linear scaling onâ€¯CPUs.                                                                                                                                  |
| **Visualisation hooks** | `interactive_view/` seeds a Plotly/Dash playground; connect directly to the DB or the JSON file.                                                                                                                   |
| **Documentation**       | `nse_options_formulae.pdf` explains every calculation and assumption.                                                                                                                                              |

---

## âš™ï¸ Quickâ€‘start

### 0.  Environment

```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
```

### 1.  (Optional) refresh the F\&O script list

```bash
python scripts/nse_fno_scripts.py
```

### 2.  Download raw data

*(Bhavcopies until Aprâ€‘2025 already included; run these only for new dates)*

```bash
python scripts/download_bhavcopy.py       # Bhavcopy ZIPs â†’ CSVs
python scripts/download_yahoo_data.py     # Underlying spot prices
```

### 3â€‘A.  **JSONâ€‘only** pipeline

```bash
python process_data.py                    # writes processed_data/processed_data.json
```

### 3â€‘B.  **PostgreSQL** pipeline (preferred)

1. Create a DB and tableâ€¯`option_metrics` (DDL in `store_in_db/schema.sql`).
2. Export PG creds as envâ€‘vars **or** set `PG_DSN`.
3. Run:

   ```bash
   cd store_in_db
   python store_s.py                     # multiâ€‘threaded ETL â†’ Postgres
   ```

*Tunable envâ€vars:*

| Var                 | Default | Description                  |
| ------------------- | ------- | ---------------------------- |
| `BATCH_SIZE`        | 1000    | rows per bulk upsert         |
| `PG_SSLMODE`        | require | SSL mode (disable for local) |
| `MAX_WORKERS`       | auto    | threads = `min(8,Â CPU)`      |
| `STATEMENT_TIMEOUT` | 0       | session timeout (ms)         |

---

## ğŸ§  Sample JSON snapshot

```jsonc
{
  "historical": {
    "scripts": {
      "NIFTY": {
        "02-May-2025": {
          "underlying_price": 22715.2,
          "interest_rate": 7.78,
          "upcoming_earning_date": null,
          "expiry_30d": "29-May-2025",
          "expiry_60d": "26-Jun-2025",
          "expiry_90d": "31-Jul-2025",
          "strike_price": 22700.0,
          "rv_yz": 11.32,
          "ce": {
            "iv_30": 13.4,
            "iv_60": 14.1,
            "iv_90": 15.3,
            "volume": 181492,
            "ivp": 78.6,
            "ivr": 62.4,
            "greeks": { "delta": 0.52, "gamma": 0.0007 }
          },
          "pe": { â€¦ },
          "option_chain": [ â€¦ 1200 rows â€¦ ]
        }
      }
    }
  }
}
```

---

## ğŸ—„ï¸ Database schema (PostgreSQL)

```sql
CREATE TABLE option_metrics (
  symbol              TEXT    NOT NULL,
  date                DATE    NOT NULL,
  underlying_price    DOUBLE PRECISION,
  interest_rate       DOUBLE PRECISION,
  strike_price        DOUBLE PRECISION,
  expiry_30d          DATE,
  expiry_60d          DATE,
  expiry_90d          DATE,
  upcoming_earning_date DATE,
  rv_yz               DOUBLE PRECISION,
  ce                  JSONB,
  pe                  JSONB,
  option_chain        JSONB,
  extras              JSONB,
  PRIMARY KEY (symbol, date)
);
```

The ETL performs `INSERTâ€¯â€¦â€¯ONâ€¯CONFLICTâ€¯DOâ€¯UPDATE`, so reruns are idempotent.

---

## ğŸ”® Roadâ€‘map

* ğŸŒ Live chain capture via broker WebSockets (Dhan, Zerodha, FYERS)
* ğŸ“ˆ Realâ€‘time dashboards (Plotlyâ€‘Dash & Superset)
* ğŸ¤– Volatilityâ€‘surface fitting & Monteâ€‘Carlo pricers
* ğŸƒâ€â™‚ï¸ Streaming pipeline with ApacheÂ Airflow + TimescaleDB

---

## ğŸ“š Data sources

| Source                       | Usage                          |
| ---------------------------- | ------------------------------ |
| **NSE Bhavcopy**             | Official market snapshot (EOD) |
| **Yahooâ€¯Finance**            | Spot prices for IV calc        |
| **FBIL MIFOR**               | Daily INR riskâ€‘free proxy      |
| **Sensibull API / Raw JSON** | Corporate actions & earnings   |

---

## ğŸ” Licence

Nonâ€‘commercial, research & educational use.
You **must** comply with upstream providers (NSE, FBIL, Yahoo, etc.) when redistributing or displaying data.

---

## ğŸ‘¤ Author

**SajalÂ Agrawal** â€” Founder, SajalÂ TechÂ Solutionsâ€¯Pvtâ€¯Ltd
ğŸŒâ€¯[sajaltech.com](https://sajaltech.com)â€‚|â€‚âœ‰â€¯[sajal@sajaltech.com](mailto:sajal@sajaltech.com)

---

## ğŸ¤ Contributing

Bugâ€‘reports, pullâ€‘requests, and feature discussions are warmly welcome.
Letâ€™s keep pushing the frontier of openâ€‘source options analytics! ğŸš€
